<html>
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" > 
      <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
      <link type="text/css" rel="stylesheet" href="css/jquery.contextMenu.css">
      <link rel="stylesheet" href="css/dhtmlwindow.css" type="text/css">
      <link type="text/css" rel="stylesheet" href="js9.css">
      <script type="text/javascript" src="js/jquery.min.js"></script>
      <script type="text/javascript" src="js/kinetic.min.js"></script>
      <script type="text/javascript" src="js/jquery.contextMenu.min.js"></script>
      <script type="text/javascript" src="js/jquery.flot.min.js"></script>
      <script type="text/javascript" src="js/jquery.flot.errorbars.min.js"></script>
      <script type="text/javascript" src="js/sprintf.min.js"></script>
      <script type="text/javascript" src="js/dhtmlwindow.min.js">
      /***********************************************
      * DHTML Window Widget- Â© Dynamic Drive (www.dynamicdrive.com)
      * This notice must stay intact for legal use.
      * Visit http://www.dynamicdrive.com/ for full source code
      ***********************************************/
      </script>
      <script type="text/javascript" src="js/archive/subst.js"></script>

      <script type="text/javascript" src="js/fitsy.js"></script>
      <script type="text/javascript" src="js/astrolib.js"></script>
      <script type="text/javascript" src="js9.js"></script>

        <script>

	function status(message) {
	    $("#status").text(message)
	}


 	function xhr(params, func) {
	    var title = ""
	    var xhr = new XMLHttpRequest();

	    xhr.open('GET', params.url, true);

	    if ( params.title ) {
		title = params.title
	    }
	    if ( params.type ) {
		xhr.responseType = params.type;
	    }

	    if ( params.status ) {
		xhr.addEventListener("progress"	, function(e) { $(params.status).text(title + " progress " + e.loaded.toString()) });
		xhr.addEventListener("error"	, function(e) { $(params.status).text(title + " service error"); });
		xhr.addEventListener("abort"	, function(e) { $(params.status).text(title + " service aborted"); });
	    }
	    xhr.onload = function(e) {
		if ( this.readyState === 4 ) {
		    if ( this.status === 200 || this.status === 0 ) {
			if ( params.status != undefined ) { $(params.status).text(""); }
			func(e, this)
		    }
		}
	    })
	    xhr.send();

	    return xhr;
	}

	function GetRADec() {
	    var im = JS9.GetImage()
	    var form = $("#catalog-box")[0]

	    var coords = JS9.pix2wcs(im.iwcs, im.raw.header.NAXIS1/2, im.raw.header.NAXIS2/2).split(/ +/)

	    form.ra.value = coords[0]
	    form.dec.value = coords[1]

	    var c1 = JS9.Pix2WCS(im, 0,                    im.raw.header.NAXIS2/2)
	    var c2 = JS9.Pix2WCS(im, im.raw.header.NAXIS1, im.raw.header.NAXIS2/2)

	    form.width.value = Math.floor(Math.abs((c1[0]-c2[0])*60)*100)/100

	    var c1 = JS9.Pix2WCS(im, im.raw.header.NAXIS1/2,                    0)
	    var c2 = JS9.Pix2WCS(im, im.raw.header.NAXIS1/2, im.raw.header.NAXIS2)

	    form.height.value = Math.floor(Math.abs((c1[1]-c2[1])*60)*100)/100
	}


	function ServiceGo() {
	    var form = $("#archive-box")[0]

	    if ( form.object.value === "" && ( form.ra.value === "" || form.dec.value === "" ) ) {
		return;
	    }

	    w = parseFloat(form.width.value)
	    h = parseFloat(form.height.value)

	    if ( w > 60 ) {
		form.width.value = "60";
		w = 60;
	    }
	    if ( h > 60 ) {
		form.height.value = "60";
		h = 60;
	    }

	    var service = form.service.options[form.service.selectedIndex].value.split(":")
	    var source  = form.service.options[form.service.selectedIndex].innerHTML
	    var server  = Services[service[0]]
	    
	    service = service[1]
	    
	    if ( form.object.value !== "" ) {
		simbad=encodeURI('http://hopper.si.edu/http/simbad?' + form.object.value)

		xhr({ url: simbad, title: "Name", status: "#status" }, function(e, xhr) {
		    var coords = xhr.responseText.split(" ");

		    form.ra.value  = coords[0]
		    form.dec.value = coords[1]

		    $("#status").text("");

		    server.retrieve({ name: form.object.value, e: "J2000", h: h.toString(), w: w.toString()
				    , r: form.ra.value, d: form.dec.value
				    , c: form.gzip.checked
				    , s: service
				    , source : source

				    , proxy: form.proxy.checked
				  }
				, $("#status"));
		})

		return
	    }

	    server.retrieve({ name: form.object.value, e: "J2000", h: h.toString(), w: w.toString()
			    , r: form.ra.value, d: form.dec.value
			    , c: form.gzip.checked
			    , s: service

			    , proxy: form.proxy.checked
			  }
			, $("#status"));
	}

	function ImageService(params) {
	    this.params = params;

	    this.retrieve = function (values, messages) {

		this.params.calc(values)

		var url = subst(this.params.url, values)
		
		if ( values.proxy ) {
		    url = url.replace(/\?/g, "@")
		    url = url.replace(/&/g, "!")
		    url = url.replace(/\+/g, "")

		    url = encodeURI(url)

		    url="http://hopper.si.edu/http/CORS-proxy?Q=" + url
		}
		xhr({ url: url, title: "Image", status: params.status, type: 'blob' }, function(e, xhr) {
		    blob      = new Blob([xhr.response]);
		    blob.name = values.name

		    Fitsy.fitsopen(blob, function(fits) {
			    var hdu = fits.hdu[0];

			    if ( hdu.databytes === 0 && fits.hdu[1] !== undefined ) {
				hdu = fits.hdu[1];
			    }

			    Fitsy.dataread(fits, hdu, params.deliver);
		    };
		})
	    }
	}

	saoDSS = new ImageService({
	      url: "http://www.cfa.harvard.edu/archive/dss?r={r}&d={d}&w={w}&h={h}&e={e}&c={c}"
	    , calc: function(values) {
		    if ( values.c ) {
			values.c = "gzip"
		    }
		    values.name = values.name + " " + values.source;
		}
	})

	stsDSS = new ImageService({
	      url: "http://stdatu.stsci.edu/cgi-bin/dss_search?r={r}&d={d}&w={w}&h={h}&e={e}&c={c}&v={s}&f=fits"
	    , calc: function(values) {
		    if ( values.c ) {
			values.c = "gz"
		    } else {
			values.c = "none"
		    }
		    values.name = values.name + " " + values.source;
		}
	})

	esoDSS = new ImageService({
	      url: "http://archive.eso.org/dss/dss?ra={r}&dec={d}&equinox=J2000&x={w}&y={h}&mime-type={c}&Sky-Survey={s}"
	    , calc: function(values) {
		    if ( values.c ) {
			values.c = "display/gz-fits"
		    } else {
			values.c = "application/x-fits"
		    }
		    values.name = values.name + " " + values.source;
		}
	})

	ipac2m  = new ImageService({
	      url: "http://irsa.ipac.caltech.edu/cgi-bin/Oasis/2MASSImg/nph-2massimg?objstr={r},{d}&size={radius}&band={s}"
	    , calc: function(values) {
		    values.radius = Math.floor(Math.sqrt(values.w*values.w+values.h*values.h)*60)
		    values.name = values.name + " " + values.source;
		}
	})

	skyvew  = new ImageService({
	      url: "http://skys.gsfc.nasa.gov/cgi-bin/images?VCOORD={ra},{dec}&SURVEY={s}&SFACTR={size}&RETURN=FITS"
	    , calc: function(values) {
		    values.size = Math.floor((values.w+values.h)/2)
		    values.name = values.name + " " + values.source;
		}
	})

	function CatalogService(params) {
	    this.params = params;

	    this.table2cat = function(im, table) {
		var i
		var shape = this.params.shape;

		var xcol = table[this.params.xcol]
		var ycol = table[this.params.ycol]

		var wcol = 1;
		var hcol = 1;


		var pos_func = function(im, x, y) {
		    var coords = JS9.WCS2Pix(im, x, y)

		    return { x: coords[0], y: coords[1] }
		}
		var sizefunc;

		switch ( shape ) {
		 case "box":
		    sizefunc = function(row) {
			    return { width: 5, height: 5 };
		    	}
		    break;
		 case "circle":
		    sizefunc = function(row) {
			    return { radius: 2.5 };
		    	}
		    break;
		 case "ellipse":
		    sizefunc = function(row) {
			    return { width: 5, height: 5 };
		    	}
		    break;
		}

		regs = []
		for ( i = 0; i < table.data.length; i++ ) {
		    var pos = pos_func(im, table.data[i][xcol]*15, table.data[i][ycol])
		    var siz = sizefunc(im, table.data[i][wcol], table.data[i][hcol])

		    var reg = {   id: i.toString(), shape: shape
				, x: pos.x, y: pos.y
				, width: siz.width, height: siz.height, radius: siz.radius
				, angle: 0
			}

		    regs[i] = reg
		}

		return regs
	    }

	    this.retrieve = function (values, messages) {

		this.params.calc(values)

		var url = subst(this.params.url, values)
		
		if ( values.proxy ) {
		    url = url.replace(/\?/g, "@")
		    url = url.replace(/&/g, "!")
		    url = url.replace(/\+/g, "")

		    url = encodeURI(url)

		    url="http://hopper.si.edu/http/CORS-proxy?Q=" + url
		}

		var catalog = this;

		var reply = xhr({ url: url, title: "Catalog", status: "#status" }, function(e) {
		    var table = new Starbase(reply.responseText, { type: { default: Strtod } })
		    var im    = JS9.GetImage()

		    JS9_Catalog(im, catalog.name, catalog.table2cat(im, table))
		})
		reply.addEventListener("progress", function(e) { status("progress " + e.loaded.toString()) });
		reply.addEventListener("error"	 , function(e) { status("Catalog service error"); });
		reply.addEventListener("abort"	 , function(e) { status("Catalog service aborted"); });
	        reply.send();
	    }
	}

	saoCat = new CatalogService({
	      url: "http://www.cfa.harvard.edu/catalog/scat?catalog={cat}&ra={r}&dec={d}&width={w}&height={h}&system={e}&compress={c}"
	    , calc: function(values) {
		    if ( values.c ) {
			values.c = "gzip"
		    }
		    values.w    = values.w*60
		    values.h    = values.h*60
		    values.name = values.name + " " + values.source;
		}

	    , shape: "circle"
	    , xcol:  "ra", ycol: "dec"
	
	})


	Servers = {   saoCat: saoCat
		}

	Services = {   saoDSS: saoDSS
		    , stsDSS: stsDSS
		    , esoDSS: esoDSS
		    , ipac2m: ipac2m
		    , skyvew: skyvew
		}

        </script>
    </head>
    <body>
    <div class="JS9Menubar"></div>
    <div class="JS9"></div>

        <br>
	<form id="archive-box">


	Image archive : <select name=service>
			<option value=saoDSS>SAO DSS1</option>
			<optgroup label="StSci DSS">
			    <option value=stsDSS:poss2ukstu_ir>StSci DSS2 Infrared</option>
			    <option value=stsDSS:poss2ukstu_red>StSci DSS2 Red</option>
			    <option value=stsDSS:poss2ukstu_blue>StSci DSS2 Blue</option>
			    <option value=stsDSS:poss1_red>StSci DSS1 Red</option>
			    <option value=stsDSS:poss1_blue>StSci DSS1 Blue</option>
			</optgroup>
			<optgroup label="ESO DSS">
			    <option value=esoDSS:DSS2-infrared>ESO DSS2 Infrared</option>
			    <option value=esoDSS:DSS2-red>ESO DSS2 Red</option>
			    <option value=esoDSS:DSS2-blue>ESO DSS2 Blue</option>
			    <option value=esoDSS:DSS1>ESO DSS1</option>
			</optgroup>
			<optgroup label="IPAC 2mass">
			    <option value=ipac2m:j>IPAC 2Mass J</option>
			    <option value=ipac2m:h>IPAC 2Mass H</option>
			    <option value=ipac2m:k>IPAC 2Mass K</option>
			</optgroup>

<!--
			<optgroup label="HEASARC SkyView">
			    <option value=skyvew:sdssi>SkyView SDSS i</option>
			    <option value=skyvew:sdssr>SkyView SDSS r</option>
			    <option value=skyvew:sdssg>SkyView SDSS g</option>
			    <option value=skyvew:sdssu>SkyView SDSS u</option>
			    <option value=skyvew:sdssz>SkyView SDSS z</option>
--!>
			</optgroup>
			</select>
			<p>

	<table>
	<tr><td> Object: </td> <td> <input type=text name=object size=10> </td>
	    <td></td>
	    <td></td>
	    <td> <input type=button value=Go onclick='ServiceGo()'> </td>
	    <td>&nbsp;&nbsp;</td>
	    <td> <input type=checkbox name=gzip> Use Compression</td>
	</tr>
	<tr><td> RA:  	</td><td>	<input type=text name=ra	size=10> </td>
	    <td> Dec: 	</td><td>	<input type=text name=dec	size=10> </td>
	    <td> <input type=button value=Get onclick='GetRADec()'> </td>
	    <td></td>
	    <td> <input type=checkbox name=proxy checked> Use CORS Proxy</td>
	<tr><td> Width: </td><td>	<input type=text name=width	size=10 value=15> </td>
	    <td> Height: </td><td>	<input type=text name=height	size=10 value=15> </td>
	</tr>
	</tr>
	<tr><td colspan=6><span id=status></span></td></tr>

	</form>
    </body>
</html>
